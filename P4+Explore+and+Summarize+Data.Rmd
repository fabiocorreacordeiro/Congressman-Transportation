---
title: "P4 Explore and Summarize Data"
author: "Fabio Correa Cordeiro"
date: "01/ago/2017"
output:
  html_document: default
  pdf_document: default
runtime: shyne
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10)
```


# Exploratory Descriptive Analysis of Congressman Local Transportation


This is Exploratory Descriptive Analisys of expendure with local transportation made with Brazilian Congressmen dataset. We worked with data generated by [Operação Serenata de Amor](https://github.com/datasciencebr/serenata-de-amor), a project that built an intelligence capable of analyzing public spending and saying, with reliability, the possibility of each receipt being unlawful. In this document, we will analyze the congressmen of Rio de Janeiro state, but when changing the variable "state_target" is possible to check the other states.

The first step is read the original data and subset the data of local transportation of all reimbursements


```{R}
library(dplyr)
library(ggplot2)
library(zoo)
library(lubridate)
library(psych)
library(knitr)
```

```{R}
# With this target is possible to choose the state of analyze
state_target <- 'RJ'

# There are several subquotas of congressmen expenses, we will
# subset the dataset only for that ones it's related to local 
# transportation. We also will subset by "state_target".
reimbursements <- read.csv('2017-03-15-reimbursements.xz', sep = ',', stringsAsFactors = FALSE)
local_transportation <- subset(reimbursements, state == state_target)
local_transportation <- subset(local_transportation,
                              subquota_description == 'Automotive vehicle renting or charter' |
                              subquota_description == 'Fuels and lubricants' |
                              subquota_description == 'Taxi, toll and parking' |
                              subquota_description == 'Watercraft renting or charter' |
                              subquota_description == 'Automotive vehicle renting or watercraft charter'    
                              )
```


First of all, let's check the distribution of the "total_net_value" of each reimbursement.


```{R}
ggplot(local_transportation, aes(total_net_value)) +
        geom_histogram() +
        xlab("Total Net Value") +
        labs(title = "Total Net Value distribution")
```


Almost all reimbursement is less than R 5.000, but there is a long tail with some expenditure near of R$ 30.000. For a better visualization of the long tail, we will use a log10 transformation on the X axis.


```{R}
ggplot(local_transportation, aes(total_net_value)) +
        geom_histogram() +
        xlab("Total Net Value") +
        labs(title = "Total Net Value log10 distribution") +
        scale_x_log10()
```

```{R}
summary(local_transportation$total_net_value)
```


Now we can see that almost all expenditure is less than a hundred of reais, but there is a suspicious peak between a thousand and ten thousand reais.

Let's see the distribution of the reimbursements by the subquotas.


```{r}
subquotas <- group_by(local_transportation,
                      subquota_description)
subquotas <- summarize(subquotas,
                       total_reimbursements = length(total_net_value),
                       total_net_value = sum(total_net_value))
```

```{r}
ggplot(subquotas, aes(subquota_description)) +
  geom_bar(aes(weight = total_net_value / 1000000)) +
  ylab("Expenses in R$ million") +
  xlab("Subquotas") +
  labs(title = "Expenses by subquotas") +
  theme(axis.text=element_text(angle = 30, size = 8, hjust=0.95, vjust=0.2))
```

```{r}
ggplot(subquotas, aes(subquota_description)) +
  geom_bar(aes(weight = total_reimbursements)) +
  ylab("Count") +
  xlab("Subquotas") +
  labs(title = "Reimbursements by subquotas") +
  theme(axis.text=element_text(angle = 30, size = 8, hjust=0.95, vjust=0.2))
```

```{r}
kable(subquotas)
```


Then, we will group the data by month.


```{R}
group <- function(data) {
  # This function get the dataset and group it by subquota_description,
  # congressperson_id,"congressperson_name" and "year_month". 
  data_grouped <- group_by(data,congressperson_id,
                           congressperson_name, 
                           year,
                           month,
                           subquota_description,add=TRUE)
  data_grouped <- summarise(data_grouped,
                            total_net_value = sum(total_net_value))
  data_grouped$month_year <- dmy(paste('01',
                                       month.abb[data_grouped$month],
                                       data_grouped$year,
                                       sep = '/'))
  data_grouped$month_year <- as.Date(data_grouped$month_year)
  return(data_grouped)
}

transportation <- group(local_transportation)
```

```{R}
group_by_month <- function(data) {
  # This function get the dataset and group it by subquota_description and "year_month".
    data_month <- group_by(data, month_year,  subquota_description)
    data_month <- summarise(data_month,
                            total_net_value = sum(total_net_value))
    return(data_month)
}

transportation_month <- group_by_month(transportation)
```


And plot the sum of all expenses of all congressman per month.


```{r}
plot_col <- function(data) {
  # The function plot a expenses by month bar charter
    ggplot(data, aes(month_year)) +
        geom_bar(aes(weight = (total_net_value / 1000), fill =  subquota_description)) +
        ylab("Expenses in R$ thousand") +
        xlab("Year") +
        labs(title = "Expenses by month") +
        scale_x_date(date_breaks = '1 year') +
        theme(legend.position = "bottom") +
        theme(legend.text=element_text(size = 7)) +
        theme(legend.title=element_blank())
}

plot_col(transportation_month)
```

```{R}
summary(transportation_month$total_net_value)
```


In the end of 2013, we can see that subquota "Automotive vehicle renting or watercraft charter" was changed by "Automotive vehicle renting" and watercraft renting or charter". We can observe monthly expenses about R$200.000 with a seasonal variation.

Now we will check how was the expenses of each congressperson by month.


```{r}
group_by_congressmam <- function(data) {
  # This function group the data by congressmen and summarise 
  # the "total_net_value" using the mean, median, 5th and 95th quantil
  data_congressperson_month <- group_by(data,
                                        congressperson_id,
                                        congressperson_name,
                                        month_year,
                                        add = TRUE)
  data_congressperson_month <- summarise(data_congressperson_month,
                                         total_net_value = sum(total_net_value))
  data_congressperson_mean <- group_by(data_congressperson_month,
                                       congressperson_name,
                                       congressperson_id)
  data_congressperson_mean <- summarise(data_congressperson_mean,
                                        mean_net_value = mean(total_net_value),
                                        median_net_value = median(total_net_value),
                                        quantil_5percent_net_value = quantile(total_net_value, 0.05),
                                        quantil_95percent_net_value = quantile(total_net_value, 0.95))
  data_congressperson_mean <- arrange(data_congressperson_mean, desc(mean_net_value))
}

transportation_congressperson_mean <- group_by_congressmam(transportation)
```

```{r}
plot_distribution <- function(data) {
  # Plot the Mean of monthly expenses by congressman columns charter
  data$congressperson_id <- as.vector(data$congressperson_id)
  data$congressperson_id <- factor(data$congressperson_id, data$congressperson_id)
  ggplot(data, aes(x = congressperson_id, y = mean_net_value)) +
    geom_col() +
    ylab("Expenses in R$/Month") +
    xlab("Congressman") +
    labs(title = "Mean of monthly expenses by congressman") +
    theme(axis.text.x=element_blank())
}

plot_distribution(transportation_congressperson_mean)
```

```{R}
summary(transportation_congressperson_mean$mean_net_value)
```


The monthly expenditure with local transportation of Rio de Janeiro congressmen is very high. 75% of them spent more than R$2.400 peer month, and there is one congressman spent almost R15.000 monthly.

Let's see more datails in the graph add the median (center dot), quantil 95% and 5% (uppeer and down limit of each bar).


```{r}
detailed_plot_distribution <- function(data) {
  # this function plot the point range charter
  data$congressperson_id <- as.vector(data$congressperson_id)
  data$congressperson_id <- factor(data$congressperson_id, data$congressperson_id)
  ggplot(data = data,
         mapping = aes(x = congressperson_id,
                       y = median_net_value,
                       ymin = quantil_5percent_net_value,
                       ymax = quantil_95percent_net_value)) +
  geom_pointrange() +
  scale_y_continuous() +
  ylab("Expenses in R$/Month") +
  xlab("Congressman") +
  labs (title = "Monthly expenses distribution by congressman") +
  theme(axis.text.x=element_blank())
}

detailed_plot_distribution(transportation_congressperson_mean)
```

```{R}
summary(transportation_congressperson_mean)
```


We can observe, even the congressmen with a low mean on "total_net_value", in some months have high expenses.

The next step is to do the same analysis for each subquota: 'Automotive vehicle renting or charter', 'Fuels and lubricants', 'Taxi, toll and parking', 'Watercraft renting or charter' and 'Automotive vehicle renting or watercraft charter'


### Automotive vehicle renting or charter


```{r}
rent_car_month <- group_by_month(subset(transportation,
                                        subquota_description == 'Automotive vehicle renting or charter'))
plot_col(rent_car_month)
```
```{R}
summary(rent_car_month$total_net_value)
```


This subquota started at the end of 2013 with an annual seasonality. The mean monthly expenditure for Rio de Janeiro Congressmen is about R$100.000.


```{r}
rent_car_congressperson_mean <- group_by_congressmam(subset(transportation,
                                                            subquota_description == 'Automotive vehicle renting or charter'))
plot_distribution(rent_car_congressperson_mean)
```

```{R}
summary(rent_car_congressperson_mean$mean_net_value)
```


It is possible to observe the same behave of the distribution in this sub quota and in the total of local transportation. More than 75% of the congressmen spent more than R$3800 per month renting a car.


```{r}
detailed_plot_distribution(rent_car_congressperson_mean)
```

```{R}
summary(rent_car_congressperson_mean)
```


In this chart we found one outlier big outlier, a R$20,000 expenditure with rent a car.


### Fuels and lubricants


```{r}
fuel_month <- group_by_month(subset(transportation,
                                    subquota_description == 'Fuels and lubricants'))
plot_col(fuel_month)
```

```{R}
summary(fuel_month$total_net_value)
```


The monthly expenditure with fuel by Rio de Janeiro Congressmen is about R$90,000 with the same annual seasonality.


```{r}
fuel_congressperson_mean <- group_by_congressmam(subset(transportation,
                                                        subquota_description == 'Fuels and lubricants'))
plot_distribution(fuel_congressperson_mean)
```

```{R}
summary(fuel_congressperson_mean$mean_net_value)
```

```{r}
detailed_plot_distribution(fuel_congressperson_mean)
```

```{R}
summary(fuel_congressperson_mean)
```


Analyzing the last two charts we can observe a very variability between the congressmen and between the expenses of the same congressman.


### Taxi, toll and parking


```{r}
taxi_month <- group_by_month(subset(transportation, 
                                    subquota_description == 'Taxi, toll and parking'))
plot_col(taxi_month)
```

```{R}
summary(taxi_month$total_net_value)
```


The taxi subquota started at the end of 2013 and increase in the following years.


```{r}
taxi_congressperson_mean <- group_by_congressmam(subset(transportation, 
                                                        subquota_description == 'Taxi, toll and parking'))
plot_distribution(taxi_congressperson_mean)
```

```{R}
summary(taxi_congressperson_mean$mean_net_value)
```

```{r}
detailed_plot_distribution(taxi_congressperson_mean)
```

```{R}
summary(taxi_congressperson_mean)
```


We can see two groups of Congressmen, one has monthly expenses with taxi below of R$250 and small variability. The second group has much bigger expenses and variability, with max monthly expenses in R2,500. 


### Watercraft renting or charter


The Rio de Janeiro congressmen have only two reimbursements for watercraft renting or charter, so we don't will analyzing this subquota.


### Automotive vehicle renting or watercraft charter


```{r}
rent_car_and_boat_month <- group_by_month(subset(transportation, 
                                                 subquota_description == 'Automotive vehicle renting or watercraft charter'))
plot_col(rent_car_and_boat_month)
```

```{R}
summary(rent_car_and_boat_month$total_net_value)
```


The subquota "Automotive vehicle renting or watercraft charter" started in 2009 and finished in the end of 2013. The mean value increased over time, and the final mean value is similar of the subquota "Automotive vehicle renting or charter" which replaced it.


```{r}
rent_car_and_boat_congressperson_mean <- group_by_congressmam(subset(transportation, 
                                                                     subquota_description == 'Automotive vehicle renting or watercraft charter'))
plot_distribution(rent_car_and_boat_congressperson_mean)
```

```{R}
summary(rent_car_and_boat_congressperson_mean$mean_net_value)
```

```{r}
detailed_plot_distribution(rent_car_and_boat_congressperson_mean)
```

```{R}
summary(rent_car_and_boat_congressperson_mean)
```


How occurred in the previews subquotas, there is a variety of congressmen behavior. There are some congressmen spent few reais per month and other more than R$15,000 (with outliers of almost R25,000).


# Suspicious reimbursements


Finally, we will be looking for suspicious reimbursements in only one subquota. We choose 'Fuels and lubricants' because is easier transform the expenses in an objective product.
We will try to find some suspect reimbursements in subquota "Fuel and lubricants" using the worst case acceptable. We will find a limit to expenses, any reimbursement greater than this limit we will consider a suspect reimbursement.


### We will consider suspecting all reimbursements that exceed the max cost of R$917.00.


The max cost was calculate using the worst case that is possible to fill a gas and lubricant tank of a car. We used the biggest gas tank in Brazilian market (Ford F-250 with 110l tank),
the cost of gas in the most expense gas station in Brazil (R4.70) and 10l of most expensive lubricant (R$40.00). Most of the service stations don't charge to change lubricants.

Sources: 

[Cost of gas](http://www.anp.gov.br/preco/prc/Resumo_Semanal_Combustiveis.asp in 25/apr/2017)

[Lubricant capacity](http://www.autoideia.com.br/capacidade_oleo_motor_automoveis&codmar=ford)

[Cost of lubricant](http://www.mercadomineiro.com.br/pesquisa/oleo-lubrificante-pesquisa-precos)

[Tanks size](https://panelinhanet.wordpress.com/2013/02/20/combustivel-quantos-litros-cabem-no-tanque-do-seu-veiculo/)  in 18/mar/2017 


```{r}
fuel_cost <- 4.70
fuel_capacity <- 110
lubricant_cost <- 40
lubricant_capacity <- 10
max_cost <- fuel_cost * fuel_capacity + lubricant_cost * lubricant_capacity
max_cost
```


Now, let's plot the distribution of these supect reimbursements.


```{r}
fuel_outliers <- subset(local_transportation, 
                       (subquota_description == 'Fuels and lubricants' & total_net_value > max_cost))

plot_outliers <- function(data) {
  # Plot the histogram of suspicious Reimbursements
  ggplot(data, aes(total_net_value)) +
    geom_histogram(bins = 200) +
    xlab("Expenses in R$") +
    labs(title = "Suspicious Reimbursements")  
  }

plot_outliers(fuel_outliers)
```

```{r}
summary(fuel_outliers$total_net_value)
sum(fuel_outliers$total_net_value)
```


There is a very high concentration of reimbursement on the actual limit of monthly expense with fuel.


```{r}
fuel_outliers_group <- group(fuel_outliers)
fuel_outliers_month <- group_by_month(fuel_outliers_group)
plot_col(fuel_outliers_month)
```

```{R}
summary(fuel_outliers_month$total_net_value)
```


When we see the distribution of the suspects by month, we realized that the Brazilian people pay every month about R$40.000 in fraud or mistakes, only in this subquota for Rio de Janeiro Congressmen.


```{r}
fuel_outliers_congressperson_mean <- group_by_congressmam(fuel_outliers_group)
detailed_plot_distribution(fuel_outliers_congressperson_mean)
```

```{R}
summary(fuel_outliers_congressperson_mean)
```


Finally, we can observe how systematic is the behave of this 53 suspect congressmen.


# Final Plots and Summary


In this exploratory analysis we checked the expenses made by Rio de Janeiro Congressmen in local transportation. The reimbursements are grouped in five subquotas. Initially, there were only two subquotas, "Fuel and Lubricant" and "Automotive Vehicle renting and watercraft charter". Near of 2014 there were some changes in the legislation, "Taxi, toll and parking" was created and Cars and Watercrafts renting were split.


```{r}
plot_col(transportation_month)
```


Every month these congressmen spent about R$200,000 with local transportation. Almost all services in "Automotive Vehicle renting and watercraft charter" was to rent a car, very few congressmen in Rio de Janeiro rent a boat. "Taxi, toll and parking" were cheaperservices, so has a smaller impact.

We choose the "Fuel and lubricant" subquotas for a detailed view of how was the mean expenditure of each congressman because they were more constant along the time.


```{r}
plot_distribution(fuel_congressperson_mean) +
  geom_hline(yintercept = 1000)
```

```{r}
summary(fuel_congressperson_mean$mean_net_value)
```


75% of Rio de Janeiro Congressmen spent more than R$1000 per month in fuel, it is a value very high if we compare with expenses of ordinary people.

So, we decided looking for suspicious reimbursements in "Fuel and lubricant" subquota. We considered suspecting all reimbursements that exceed the max cost of R$917.00.

The max cost was calculated using the worst case that is possible to fill a gas and lubricant tank of a car. We used the biggest gas tank in Brazilian market (Ford F-250 with 110l tank), the cost of gas in the most expense gas station in Brazil (R4.70) and 10l of most expensive lubricant (R$40.00).


```{r}
plot_outliers(fuel_outliers)
```

```{r}
print (summary(fuel_outliers$total_net_value))
print ('Total: ')
print (sum(fuel_outliers$total_net_value))
print ('length: ')
print (length(fuel_outliers$total_net_value))

```


In this chart, we plot every reibursement that a Rio de Janeiro Congressmen got when fill a gas tank and paid more that is possible. Considering R$917 the maximum cost of a fuel reimbursement, we found 1,380 suspicious reimbursement, tt represents R4,002,959 since 2009.

From 2009 to 2013, when this legislation was changed, the alowed  limit in this subquota was R$4500, exactly the value of the big bar that we can see on the chart. Today the limit is R6000. We suspect that there are several congressmen who get a false receipt and get a reimbursement of all value allowed.


# Reflection


In this project we parse a huge dataset of Brazilian Congressmen expenses. We need to choose what kind of expenses we would like investigate. We choose the local transportation because urban mobility is a big problem in Brazil, especially in the big cities.

In the first time we analyzed all states, but there were a lot of congressmen in the plot. Then the focus changed for only one state, Rio de Janeiro.

We could found 1380 (R$4 millions) of suspicious reimbursements since 2009. This is an example how mistakes and small frauds could become a big loss for the people. The next step is to make a good data visualization to show these suspects to the public. 

We were conservative in this values, we used a very high value to fill a gas tank, the most people expend much less in them cars. In the same way, we didn't consider inflation, if we did, the number of suspicious reimbursements would be bigger than we found. 

We have analyzed only a small part of the database, a similar work could be done on the others states and subquotas. The [Operação Serenata de Amor](https://github.com/datasciencebr/serenata-de-amor) team are working on several others kinds of suspects.